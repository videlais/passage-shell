<html>
<body>
	<script>

		// Load the electron module with the ipcRenderer object
		const { ipcRenderer } = require('electron');

	    // Wait for Twine to load the <tw-storydata> element
	    function waitForInk() {

	    	// Get the iframe
			var iframe = document.getElementById("webframe");
			// Get its document object
			var iframeDocument = iframe.contentWindow.document;
			// Find the <tw-storydata> element and populate its data
			
			// Send the status
			//ipcRenderer.send('async-main-status', story);

			// TODO
			// Figure out what to watch for to see if it is loaded and ready

	    	// If it doesn't exist, loop again
	    	/*if(passage == null) {

				// Wait for default 4ms before trying again
	    		window.setTimeout(waitForInk);

	    	} else {
	    		// Everything is now ready!*/
	    		frameReady();

	    	//}

	    }

		function frameReady() {

			// Get the iframe (again)
			var iframe = document.getElementById("webframe");
			// Get its document object (again)
			var iframeDocument = iframe.contentWindow.document;

			function refreshLinks() {

				var linksArray = []

				// Send links content
				ipcRenderer.send('async-main-links', linksArray);

			}

			function refresh() {

				// Set a default value
				var passage = null;

				// Get the iframe (again)
				var iframe = document.getElementById("webframe");
				// Get its document object (again)
				var iframeDocument = iframe.contentWindow.document;

				// Send text content
				//ipcRenderer.send('async-main-text', passage.innerText);
				// Send HTML content
				//ipcRenderer.send('async-main-html', passage.innerHTML);

				// Refresh the links array
				refreshLinks();

			}

			// Send the first update
			refresh();

			ipcRenderer.on('async-remote-click', function(event, arg) {

				// Do a sanity check
				// 	arg should be greater than 0
				// 	arg should be less than number of results
				//	results should be more than 0
				if(arg >= 0 && 
				   arg < linksArray.length && 
				   linksArray.length > 0) {

					var event = new MouseEvent('click', {
						view: window,
						bubbles: true,
						cancelable: true
					});

					try {
						// Click the link or link-like element
						linksArray[arg].element.dispatchEvent(event);

					} catch (event) {

						ipcRenderer.send('async-main-status', {"error": "Could not click link or link-like element!"});

					}

				}

				// Always refresh after a click event
				refresh();

			});

	}

	</script>
	<iframe id="webframe" src="index-test/index.html" style="position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;" onload="waitForInk();">
	</iframe>
</body>
</html>